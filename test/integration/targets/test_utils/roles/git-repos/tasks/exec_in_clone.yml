- block:
  - name: "Cloning {{ repository }}"
    command: 'git clone git://localhost/{{ repository }} {{ remote_tmp_dir }}/{{ repository }}'
    when: '( exec | length ) > 0'
    register: cloned_repo

  - name: "Running commands in {{ repository }}"
    shell: "{{ cmd }}"
    args:
      chdir: "{{ remote_tmp_dir }}/{{ repository }}"
    loop_control:
      loop_var: cmd
    loop: "{{ exec }}"
    register: update

  always:
    - name: "Removing {{ repository }}"
      file:
        path: "{{ remote_tmp_dir }}/{{ repository }}"
        state: absent
      when: cloned_repo is not skipped
