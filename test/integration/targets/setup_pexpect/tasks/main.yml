- vars:
    pexpect_constraint_dir: "{{ setup_pexpect_tmpdir | default(remote_tmp_dir) }}"
  block:
  - name: Copy constraints file
    copy:
      src: constraints.txt
      dest: "{{ pexpect_constraint_dir }}/pexpect-constraints.txt"

  - name: Install pexpect with --user
    pip:
      name: pexpect
      extra_args: '--user --constraint "{{ pexpect_constraint_dir }}/pexpect-constraints.txt"'
      state: present
    ignore_errors: yes  # fails when inside a virtual environment
    register: pip_user

  - name: Install pexpect
    pip:
      name: pexpect
      extra_args: '--constraint "{{ pexpect_constraint_dir }}/pexpect-constraints.txt"'
      state: present
    when: pip_user is failed
