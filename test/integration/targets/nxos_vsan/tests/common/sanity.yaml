---
- debug: msg="START nxos_vsan sanity test with connection={{ ansible_connection }} "
- debug: msg="Using provider={{ connection.transport }}"
  when: ansible_connection == "local"
- debug: msg="Using vsans {{ vsan1 }}, {{ vsan2 }} for running this sanity test, please make sure these are not used in the setup, these will be deleted after the tests"
  

- block:
  - name: Setup - Remove vsan if configured
    nxos_vsan: &remove
      vsan:
        - { id: "{{ vsan1 | int }}", remove: True}
        - { id: "{{ vsan2 | int }}", remove: True}
    ignore_errors: yes

  - name: Configure vsan
    nxos_vsan: &config
      vsan:
           - id: "{{ vsan1 | int }}"
             name: vsan-SAN-A
             suspend: True
             interface:
                - "{{intA1}}"
             remove: False
           - id: "{{ vsan2 | int }}"
             name: vsan-SAN-B
             #suspend: True
             interface:
                - "{{intB1}}"
             remove: False
    register: result

  - assert: &true
      that:
        - "result.changed == true"

  - name: Idempotence Check
    nxos_vsan: *config
    register: result

  - assert: &false
      that:
        - "result.changed == false"

  always:
  - name: Remove vsan config
    nxos_vsan: *remove
