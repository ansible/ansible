# Test code for the user module.
# (c) 2017, James Tanner <tanner.jc@gmail.com>

# This file is part of Ansible
#
# Ansible is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Ansible is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Ansible.  If not, see <http://www.gnu.org/licenses/>.
#
- name: get the jinja2 version
  shell: python -c 'import jinja2; print(jinja2.__version__)'
  register: jinja2_version
  delegate_to: localhost
- debug: var=jinja2_version

# Install SELinux bindings
# Install SELinux bindings for python
- name: Install python selinux (yum)
  yum:
    name=policycoreutils-python
    state=installed
  when: ansible_pkg_mgr == 'yum'

- name: Install python selinux (dnf)
  dnf:
    name=libselinux-python
    state=installed
  when: ansible_pkg_mgr == 'dnf'

##
## user add
##
#
- name: remove the test user
  user:
      name: ansibulluser
      state: absent

- name: try to create a user
  user:
      name: ansibulluser
      state: present
  register: user_test0
- debug: var=user_test0

- name: make a list of users
  script: userlist.sh "{{ ansible_distribution }}"
  register: user_names
- debug: var=user_names

- name: validate results for testcase 0
  assert:
      that:
          - 'user_test0.changed is defined'
          - 'user_test0.changed'
          - '"ansibulluser" in user_names.stdout_lines'

##
## user check
##

- name: run existing user check tests
  user:
      name: "{{ user_names.stdout_lines|random }}"
      state: present
      createhome: no
  with_sequence: start=1 end=5
  register: user_test1
- debug: var=user_test1

- name: validate results for testcase 1
  assert:
      that:
          - 'user_test1.results is defined'
          - 'user_test1.results|length == 5'

- name: validate changed results for testcase 1 (jinja >= 2.6)
  assert:
      that:
          - "user_test1.results|map(attribute='changed')|unique|list == [False]"
          - "user_test1.results|map(attribute='state')|unique|list == ['present']"
  when: "jinja2_version.stdout|version_compare('2.6', '>=')"

- name: validate changed results for testcase 1 (jinja >= 2.6)
  assert:
      that:
          - "not user_test1.results[0]['changed']"
          - "not user_test1.results[1]['changed']"
          - "not user_test1.results[2]['changed']"
          - "not user_test1.results[3]['changed']"
          - "not user_test1.results[4]['changed']"
          - "user_test1.results[0]['state'] == 'present'"
          - "user_test1.results[1]['state'] == 'present'"
          - "user_test1.results[2]['state'] == 'present'"
          - "user_test1.results[3]['state'] == 'present'"
          - "user_test1.results[4]['state'] == 'present'"
  when: "jinja2_version.stdout|version_compare('2.6', '<')"

##
## Create home and ssh keys for existing user
##
# Debug
- block: 
  - name: user cleanup
    user:
        name: dennis
        state: absent

  - name: try to create a second user
    user:
        name: dennis
        state: present
        createhome: false
        home: /Users/dennis
# debugging
  - name: ls users
    command: ls -l /Users/
    register: mac_debug
  - name: list debug
    debug: msg={{mac_debug.stdout_lines}}
when: ansible_distribution == 'MacOSX'

- name: try to create a second user
  user:
      name: dennis
      state: present
      createhome: false
  when: ansible_distribution != 'MacOSX'

- name: try to create home directory and ssh keys for existing user
  user:
      name: dennis
      state: present
      createhome: true
      generate_ssh_key: yes
  register: user_test3

- name: Verify existence, ownership and permissions on home and .ssh directories.
  file:
      name="{{item}}"
      state=directory
      mode=0700
      owner=dennis
  with_items:
      - "{{user_test3.home}}"
      - "{{user_test3.home}}/.ssh"

- name: Verify existence, ownership, and permissions on SSH key
  file:
      name="{{user_test3.home}}/.ssh/id_rsa"
      state=file
      mode=0600
      owner=dennis

###
# SELinux checks only if Python bindings are installed, and SELinux is on.
- block:
      - name: get context for new directories
        command: ls -lZd {{user_test3.home}} {{user_test3.home}}/.ssh
        register: user_test3a

      - name: validate ownership, permissions, and SELinux context
        assert:
            that:
                - '"user_home_dir_t" in user_test3a.stdout_lines[0]'
                - '"ssh_home_t" in user_test3a.stdout_lines[1]'
  when: ansible_selinux != False and ansible_selinux.status != "disabled"
###


##
## user remove
##


- name: remove user and home directory
  user:
      name=dennis
      state=absent
      force=yes
      remove=yes

- name: try to delete the user
  user:
      name: ansibulluser
      state: absent
  register: user_test2
- name: make a new list of users
  script: userlist.sh "{{ ansible_distribution }}"
  register: user_names2
- debug: var=user_names2
- name: validate results for testcase 2
  assert:
      that:
          - '"ansibulluser" not in user_names2.stdout_lines'
          - '"dennis" not in user_names2.stdout_lines'
