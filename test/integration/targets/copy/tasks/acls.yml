- block:
  - name: Install the acl package on Ubuntu
    apt:
      name: acl
    when: ansible_distribution in ('Ubuntu')

  - block:
    - name: Testing ACLs
      copy:
        content: "TEST"
        mode: 0644
        dest: "~/test.txt"

    - shell: getfacl ~/test.txt
      register: acls

    become: yes
    become_user: "{{ remote_unprivileged_user }}"

  - name: Check that there are no ACLs leftovers
    assert:
      that:
        - "'user:{{ remote_unprivileged_user }}:r-x\t#effective:r--' not in acls.stdout_lines"

  - name: Check that permissions match with what was set in the mode param
    assert:
      that:
        - "'user::rw-' in acls.stdout_lines"
        - "'group::r--' in acls.stdout_lines"
        - "'other::r--' in acls.stdout_lines"

  - name: Update the mode
    command: chmod 664 /home/{{ remote_unprivileged_user }}/test.txt
    become: yes

  - name: Test updating the content preserves the mode
    copy:
      content: "UPDATE"
      dest: "~/test.txt"
    register: copy_update
    become: yes
    become_user: "{{ remote_unprivileged_user }}"

  - assert:
      that: copy_update.mode == "0664"

  always:
    - name: Clean up
      file:
        path: "~/test.txt"
        state: absent
      become: yes
      become_user: "{{ remote_unprivileged_user }}"
