- name: Ensure hostname doesn't confuse NetworkManager
  when: ansible_os_family == 'RedHat' and ansible_distribution_major_version is version('8')
  block:
    - name: slurp /var/log/messages
      slurp:
        path: /var/log/messages
      become: yes
      register: messages_before

    - assert:
        that:
          - >
            'current hostname was changed outside NetworkManager' not in messages_before.content|b64decode

# This is a regression test for issue-81741
# A success or failure to change the hostname isn't a regression.
# It only matters if the hostname was intepreted as a flag.
# 
# it can succeed (maybe changing the hostname to something weird) => pass (not interpreted as flag)
#  - in this case, there will be no command_result.msg variable
#
# It can fail with an invalid option warning => fail (interpreted as flag)
# It can fail (or partially fail) with a warning dashes are bad characters => pass (not interpreted as flag)
#  - in both cases above, the warning will be in the command_result.msg variable
#
# a rescue block is used to catch the "fails" and examine the msg for errors indicating flag interpretation
- name: Ensure hostname is not interpreted as a flag
    # these weren't covered by the fix for the issue and haven't been tested either way
  when: ansible_os_family not in ['AIX', 'Darwin', 'HP-UX', 'Solaris']
  become: 'yes'
  block:
    - name: Ensure hostname is not interpreted as a flag
      hostname:
        name: -flaglike-hostname
      register: command_result
  rescue:
    - assert:
        that:
          - >
            'illegal option' not in command_result.msg
          - >
            'hostnamectl: invalid option' not in command_result.msg

- name: Run hostname module for real now
  become: 'yes'
  hostname:
    name: crocodile.ansible.test.doesthiswork.net.example.com
  register: hn2

- name: Get hostname
  command: hostname
  register: current_after_hn2

- name: Ensure hostname doesn't confuse NetworkManager
  when: ansible_os_family == 'RedHat' and ansible_distribution_major_version is version('8')
  block:
    - name: slurp /var/log/messages
      slurp:
        path: /var/log/messages
      become: yes
      register: messages_after

    - assert:
        that:
          - >
            'current hostname was changed outside NetworkManager' not in messages_after.content|b64decode

- name: Run hostname again to ensure it does not change
  become: 'yes'
  hostname:
    name: crocodile.ansible.test.doesthiswork.net.example.com
  register: hn3

- name: Get hostname
  command: hostname
  register: current_after_hn3

- assert:
    that:
      - hn2 is changed
      - hn3 is not changed
      - current_after_hn2.stdout == 'crocodile.ansible.test.doesthiswork.net.example.com'
      - current_after_hn2.stdout == current_after_hn2.stdout
